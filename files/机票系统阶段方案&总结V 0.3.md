# ✈️ 机票预订系统微服务重构总结报告 (V0.3)

## 1. 🏗️ 架构重构与基础设施 (Architecture & Infrastructure)

### 1.1 工程结构变更
*   **变更方向**：单体 Maven 项目 $\rightarrow$ Maven 父子聚合工程。
*   **核心文件**：`pom.xml` (父工程)。
*   **内容**：
    *   引入 `Spring Cloud Alibaba` (2023.0.1.0) 和 `Spring Cloud` (2023.0.1) 的 BOM (Bill of Materials) 管理依赖版本。
    *   定义子模块：`common-module`, `gateway-service`, `auth-service`, `flight-service`, `order-service`, `admin-service`。

### 1.2 公共模块 (`common-module`)
*   **定位**：系统的“工具箱” (JAR 包)，非独立运行的服务。
*   **代码文件**：
    *   `dto/`: `LoginResponse`, `BookingRequest` 等跨服务传输对象。
    *   `enums/`: `UserRole`, `TicketStatus`, `CabinClass` 等通用枚举。
    *   `security/JwtTokenProvider.java`: **核心工具**，负责生成和校验 JWT，新增了将 `role` 和 `airlineCode` 写入 Token 的功能。
    *   `util/EncryptionUtils.java`: **新增**，用于身份证号的 AES 加密/解密。
    *   `exception/GlobalExceptionHandler.java`: **优化**，增加了 Slf4j 日志打印，防止异常被吞没。
    *   `feign/`: `FlightFeignClient`, `AuthFeignClient`, `OrderFeignClient` 定义远程调用接口。
*   **遇到的问题**：
    *   **问题**：其他服务编译报错 `Symbol not found`。
    *   **解决**：必须在根目录执行 `mvn clean install -DskipTests` 将 Common 模块安装到本地 Maven 仓库。

### 1.3 服务网关 (`gateway-service`)
*   **定位**：系统的统一入口 (Port: 8080)，基于 WebFlux。
*   **核心代码**：
    *   `GatewayApplication.java`: **关键修正**，`scanBasePackages` 排除了 `common.exception`，防止 WebFlux 与 Servlet 异常处理器冲突导致 500 错误无日志。
    *   `filter/AuthGlobalFilter.java`: **重写**。拦截请求 $\rightarrow$ 校验 JWT $\rightarrow$ 解析 UserID/Role/AirlineCode $\rightarrow$ 放入 Request Header (`X-User-Name`, `X-User-Role`) 传给下游。
    *   `config/GatewaySecurityConfig.java`: **新增**。显式关闭 CSRF 保护，解决 403 Forbidden 问题。
*   **Nacos 配置 (`gateway-service.yaml`)**：
    *   配置了 `routes` (路由规则) 指向 `lb://xxx-service`。
    *   **CORS 修复**：将 `allowedOrigins: "*"` 改为 `allowedOriginPatterns: "*"`，解决了与 `allowCredentials: true` 的冲突。

---

## 2. 💾 数据库与数据安全 (Database & Security)

### 2.1 表结构演进
*   **Schema**: `plane_ticket_db` $\rightarrow$ `planetickets`。
*   **`users` 表 (原 customers)**：
    *   重命名主键 `customer_id` $\rightarrow$ `user_id`。
    *   新增 `role` (ENUM): 支持权限隔离 (USER, PLATFORM_ADMIN, AIRLINE_ADMIN)。
    *   新增 `status` (ENUM): 支持审核流程 (PENDING, ACTIVE)。
    *   新增 `airline_code`: 绑定航司管理员。
    *   **数据安全**：`password` 字段存 BCrypt 密文；`id_card` 字段长度扩容至 255 以存储 AES 密文。
*   **`tickets` 表**：外键修正为 `user_id`，切断了与 `flights` 表的物理外键关联（逻辑关联）。
*   **`daily_flight_stock` 表**：**新增**。用于解耦库存查询，避免跨服务 Count 操作。

### 2.2 安全策略
*   **密码加密**：全线启用 `BCryptPasswordEncoder`。
*   **敏感信息**：身份证号在 Service 层通过 `EncryptionUtils` 进行 AES 加密存储。
*   **内部接口保护**：各微服务的 `SecurityConfig` 配置了 `permitAll()`，因为鉴权已下放给 Gateway，但保留了 Feign 调用所需的网络通畅。

---

## 3. 🧩 微服务功能实现与联调 (Microservices)

### 3.1 认证服务 (`auth-service`) - Port: 8081
*   **功能**：注册、登录、Token 颁发、用户审核。
*   **核心代码**：
    *   `AuthController.java`:
        *   `login`: 验证密码 $\rightarrow$ 生成包含 Role 的 Token。
        *   `register`: 加密密码和身份证 $\rightarrow$ 存库。
        *   `/internal/user`: **新增**，供 Order 服务 Feign 调用，根据手机号查 UserID。
        *   `/admin/audit`: **新增**，平台管理员审核接口。
*   **解决的问题**：
    *   **500 错误**：起初因 Nacos 配置缺失（缺 JWT 密钥）导致，补全 `auth-service.yaml` 后解决。
    *   **401 错误**：因数据库手动插入明文密码导致，通过注册新用户生成 BCrypt 密码解决。

### 3.2 航班服务 (`flight-service`) - Port: 8082
*   **功能**：航班查询、管理、静态资源。
*   **核心代码**：
    *   `FlightController.java`:
        *   `searchFlights`: 集成了 Redis 缓存 (`@Cacheable`)。
        *   `getFlightByNumber`: **修正**，返回值从 `List` 改为单个对象，适配 Feign 接口定义。
        *   `/admin/list`: **新增**，根据 `X-User-Role` 和 `X-Airline-Code` 实现数据隔离查询。
    *   `PricingStrategy.java`: **优化**，改为纯计算逻辑，库存数由参数传入，不再查库。
    *   `FileController.java`: 集成 MinIO 实现图片上传。

### 3.3 订单服务 (`order-service`) - Port: 8083
*   **功能**：核心交易、订单管理。
*   **核心代码 (`TicketServiceImpl.java`)**：
    *   **完整闭环逻辑**：
        1.  接收请求 (含 `X-User-Name`)。
        2.  Feign 调用 `auth-service` 获取 UserID。
        3.  Feign 调用 `flight-service` 获取航班信息和价格。
        4.  计算价格，保存 `Ticket` 到数据库。
*   **解决的问题**：
    *   **Feign 401/403**：因 Flight/Auth 服务默认开启 Security 拦截，导致 Order 服务调用失败。通过在各服务添加 `SecurityConfig` 放行规则解决。
    *   **Feign 404**：因数据库无对应航班数据导致，通过插入真实数据解决。

### 3.4 后台管理服务 (`admin-service`) - Port: 8084
*   **功能**：数据聚合、报表统计。
*   **实现方案**：采用 **方案 B (读写分离)**。
    *   直接连接数据库，使用只读 `Repository` 或 `JdbcTemplate` 执行复杂的聚合 SQL（如热门航线、销售额）。
    *   避免了复杂的跨服务数据聚合调用。

---

## 4. 💻 前端适配 (Frontend - Vue 2)

*   **API 统一**：`src/api/index.js` 的 `baseURL` 统一指向网关 `http://localhost:8080`。
*   **登录逻辑**：
    *   使用独立的 Axios 实例请求登录接口，避免拦截器死循环。
    *   登录成功后将 Token 和 User 信息（含 Role）存入 `localStorage`。
*   **路由守卫**：
    *   `router.beforeEach` 增加了对 `meta.requiresAdmin` 的判断。
    *   根据 `user.role` 判断是否允许进入 Admin 页面。
*   **Admin 视图**：
    *   实现了 Tab 页切换（仪表盘、航班管理、审核）。
    *   根据 `isPlatformAdmin` 动态显示/隐藏“审核”Tab。

---

## 5. 🐛 踩坑与修复全记录 (Troubleshooting Summary)

这是本项目最宝贵的经验资产：

1.  **IP 漂移问题**：
    *   **现象**：Gateway 转发 500，日志显示注册 IP 为 `192.168.x.x` (虚拟网卡)。
    *   **解决**：在所有服务的 Nacos YAML 中强制配置 `spring.cloud.nacos.discovery.ip: 127.0.0.1`。
2.  **Gateway 隐式异常**：
    *   **现象**：Gateway 报 500 但无日志。
    *   **解决**：Gateway 是 WebFlux，不能扫描 `common-module` 中基于 Servlet 的 `GlobalExceptionHandler`。修改 `GatewayApplication` 的 `scanBasePackages` 精确扫描。
3.  **CORS 冲突**：
    *   **现象**：`IllegalArgumentException: ... allowedOrigins cannot contain * when allowCredentials is true`。
    *   **解决**：将 Nacos 配置中的 `allowedOrigins` 改为 `allowedOriginPatterns`。
4.  **Feign 反序列化失败**：
    *   **现象**：`DecodeException`。
    *   **解决**：Flight Controller 返回 `List`，但 Feign Client 定义返回 `Object`。修改 Controller 增加返回单个对象的方法。
5.  **Security 默认拦截**：
    *   **现象**：服务间调用报 401/403。
    *   **解决**：为每个微服务添加 `SecurityConfig`，配置 `.anyRequest().permitAll()`，仅保留 Gateway 做统一鉴权。

---

## 6. 📝 项目现阶段总结与下一步 (Current Status & Next Steps)

### ✅ 已完成 (Done)
1.  **全链路打通**：前端 $\rightarrow$ Gateway $\rightarrow$ Auth/Flight/Order/Admin $\rightarrow$ Database。
2.  **核心业务闭环**：用户注册登录、航班查询、机票预订、订单查询。
3.  **高级特性**：JWT 鉴权、RBAC 权限控制（角色隔离）、Feign 远程调用、Redis 缓存、MinIO 存储。
4.  **前端对接**：前端页面已能配合后端微服务正常工作。

### ⏳ 待优化/下一步 (To-Do)

虽然核心功能已完备，但为了达到优秀的课程设计标准，建议完善以下细节：

1.  **Admin 服务的统计接口**：
    *   目前代码已就绪，需要确保 SQL 逻辑在 `admin-service` 中正确执行，并在前端展示真实的图表数据。
2.  **数据一致性 (进阶)**：
    *   目前下单未扣减 `daily_flight_stock` 库存。可以在 `TicketServiceImpl` 中补充调用 `FlightFeignClient.reduceStock` 的逻辑。
3.  **代码清理**：
    *   清理各模块中无用的 Import 和注释。
    *   确保所有 `System.out.println` 都替换为 `@Slf4j` 日志。
4.  **部署准备**：
    *   导出最终的 SQL 脚本（包含结构和测试数据）。
    *   整理 Nacos 配置文件导出。

**总结**：已经完成了一个**架构标准、逻辑清晰、技术栈主流**的微服务系统。