### 第一部分：数据库设计调整 (MySQL)

为了支持后台管理、审批流程以及 MinIO 图片存储，建议在原有基础上修改和新增表。

#### 1. 修改 `customers` 表 -> 升级为 `users` 表
原有的 `customers` 表只针对普通乘客，现在我们需要它容纳管理员。

```sql
-- 将 customers 表重命名为 users (建议，或者保留 customers 专门存乘客，新建 admins 表，但统一用户表鉴权更方便)
ALTER TABLE customers RENAME TO users;

ALTER TABLE users 
    -- 新增角色字段：普通用户、平台管理员、航司管理员
    ADD COLUMN role ENUM('ROLE_USER', 'ROLE_PLATFORM_ADMIN', 'ROLE_AIRLINE_ADMIN') DEFAULT 'ROLE_USER',
    -- 新增关联航司字段：只有航司管理员需要此字段，指向 airlines 表
    ADD COLUMN airline_code CHAR(2) DEFAULT NULL,
    -- 新增审核状态：用于航司管理员注册后的审核 (PENDING:待审核, ACTIVE:已激活, REJECTED:已拒绝)
    ADD COLUMN status ENUM('PENDING', 'ACTIVE', 'REJECTED') DEFAULT 'ACTIVE',
    -- 新增头像/Logo字段 (MinIO URL)
    ADD COLUMN avatar_url VARCHAR(255) DEFAULT NULL;

-- 建议添加外键约束 (可选)
-- ALTER TABLE users ADD CONSTRAINT fk_users_airline FOREIGN KEY (airline_code) REFERENCES airlines(airline_code);
```

#### 2. 修改 `airlines` 表
为了支持 MinIO 存储航司 Logo。

```sql
ALTER TABLE airlines 
    ADD COLUMN logo_url VARCHAR(255) DEFAULT NULL COMMENT 'MinIO存储的图片地址';
```

#### 3. 新增 `messages` 表 (站内信)
为了实现你提到的“审核通过后通知”功能。

```sql
CREATE TABLE messages (
    message_id BIGINT AUTO_INCREMENT PK,
    sender_id INT COMMENT '发送者ID，系统通知可为0',
    receiver_id INT COMMENT '接收者ID',
    title VARCHAR(100),
    content TEXT,
    is_read BOOLEAN DEFAULT FALSE,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

### 第二部分：微服务代码结构重构

你需要将原来的单体 `Regular_customer_service` 拆分为一个 **Maven 父工程** 和多个 **子模块**。

#### 1. 推荐的目录结构

```text
plane-ticket-cloud/               # [父工程] 管理依赖版本 (Spring Cloud Alibaba, Boot)
├── pom.xml                       # 定义 <modules> 和 <dependencyManagement>
│
├── common-module/                # [公共模块] 被其他服务依赖
│   ├── src/main/java/com/bighomework/common/
│   │   ├── dto/                  # 放所有服务通用的DTO (如 UserDTO, FlightDTO)
│   │   ├── util/                 # ApiResponse, JwtUtils
│   │   ├── exception/            # GlobalExceptionHandler
│   │   └── feign/                # Feign接口定义 (例如 FlightFeignClient)
│   └── pom.xml
│
├── gateway-service/              # [网关服务] 端口 8080
│   ├── src/main/java/.../
│   │   └── filter/               # AuthGlobalFilter (统一鉴权，替代原SecurityConfig)
│   └── src/main/resources/
│       └── application.yml       # 配置 Nacos 地址和路由规则
│
├── auth-service/                 # [认证与用户服务] 端口 8081
│   ├── src/main/java/.../
│   │   ├── controller/           # AuthController, AdminUserController(审核逻辑)
│   │   ├── service/              # AuthService (注册/登录/写Redis)
│   │   ├── entity/               # User (原Customer)
│   │   └── repository/           # UserRepository
│   └── ...
│
├── flight-service/               # [航班与资源服务] 端口 8082
│   ├── src/main/java/.../
│   │   ├── controller/           # FlightController, AirlineController
│   │   ├── service/              # FlightService (读写Redis缓存)
│   │   ├── manager/              # MinioManager (封装MinIO上传逻辑)
│   │   ├── entity/               # Flight, Airline
│   │   └── repository/           # FlightRepository
│   └── ...
│
├── order-service/                # [订单服务] 端口 8083
│   ├── src/main/java/.../
│   │   ├── controller/           # BookingController
│   │   ├── service/              # TicketService (通过Feign调用FlightService扣库存)
│   │   ├── entity/               # Ticket, TicketStatusLog
│   │   └── repository/           # TicketRepository
│   └── ...
│
└── admin-service/                # [后台统计服务] 端口 8084 (新功能)
    ├── src/main/java/.../
    │   ├── controller/           # DashboardController
    │   └── service/              # StatisticsService (聚合数据)
    └── ...
```

> [!几大服务]
> admin
> auth
> flight
> gateway(微服务网关)
> order
> common-module(通用部分) 作为 **工具包（Library）**不是微服务之一



---

### 第三部分：核心迁移与修改指南

#### 1. `pom.xml` (父工程)
你需要引入 Spring Cloud Alibaba 的 BOM。
```xml
<dependencyManagement>
    <dependencies>
        <!-- Spring Cloud Alibaba -->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-alibaba-dependencies</artifactId>
            <version>2023.0.1.0</version> <!-- 对应 Spring Boot 3.2+ -->
            <type>pom</type>
            <scope>import</scope>
        </dependency>
        <!-- Spring Cloud -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-dependencies</artifactId>
            <version>2023.0.1</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```

#### 2. `auth-service` (认证服务) 修改
*   **注册逻辑升级**：
    *   如果是注册 `ROLE_AIRLINE_ADMIN`，需要前端传入 `company_name` 或 `airline_code`。
    *   将 `status` 设置为 `PENDING`。
*   **审核接口**：
    *   新增 `POST /api/admin/audit`。
    *   逻辑：平台管理员调用 -> 修改 User 表状态为 ACTIVE -> **发送消息到 RabbitMQ** (通知消息服务)。

#### 3. `flight-service` (航班服务) 修改
*   **集成 MinIO**：
    *   新增 `FileController`。
    *   逻辑：接收前端上传的图片 -> 调用 MinIO SDK 上传 -> 返回 URL。
    *   航司管理员更新资料时，将这个 URL 存入 `airlines` 表的 `logo_url`。
*   **集成 Redis**：
    *   在 `FlightService` 的 `searchAvailableFlights` 方法上加缓存。
    *   key 建议设计为：`flight:search:{出发地}:{目的地}:{日期}`。

#### 4. `order-service` (订单服务) 修改
*   **Feign 调用**：
    *   原来的 `ticketService.createTickets` 中直接调用了 `flightRepository.findById`。
    *   **修改后**：
        ```java
        // 注入 Feign Client
        @Autowired
        private FlightFeignClient flightFeignClient;

        public void createTickets(...) {
            // 远程调用获取航班信息
            ApiResponse<FlightDTO> resp = flightFeignClient.getFlightByNumber(flightNumber);
            FlightDTO flight = resp.getData();
            // ... 业务逻辑
        }
        ```

#### 5. `gateway-service` (网关)
*   **鉴权过滤器**：
    *   不要在每个微服务里写 `JwtAuthenticationFilter` 了。
    *   在网关写一个 `GlobalFilter`。
    *   逻辑：
        1.  获取 Header `Authorization`。
        2.  解析 JWT。
        3.  **查询 Redis** (看 Token 是否在黑名单/是否过期)。
        4.  如果合法，将 `userId`, `role`, `airlineCode` 放入 Request Header 传给下游微服务。

---

### 第四部分：针对后台管理的特殊逻辑实现

#### 1. 权限隔离 (在 Flight-Service 中实现)
航司管理员只能修改自己公司的航班。

```java
// FlightController.java

@PostMapping("/add")
public ApiResponse<Void> addFlight(@RequestBody FlightRequest request, 
                                   @RequestHeader("X-Role") String role,
                                   @RequestHeader("X-Airline-Code") String adminAirlineCode) {
    
    // 平台管理员可以操作所有
    if ("ROLE_PLATFORM_ADMIN".equals(role)) {
        flightService.addFlight(request);
        return ApiResponse.success(null);
    }
    
    // 航司管理员只能添加自己公司的
    if ("ROLE_AIRLINE_ADMIN".equals(role)) {
        if (!request.getAirlineCode().equals(adminAirlineCode)) {
            throw new BusinessException("无权操作其他航司数据");
        }
        flightService.addFlight(request);
        return ApiResponse.success(null);
    }
    
    throw new BusinessException("权限不足");
}
```

#### 2. 数据统计 (Admin-Service)
*   这是一个全新的模块。
*   它不直接连数据库（或者只连自己的统计结果表）。
*   它通过 Feign 调用 `order-service` 获取每日订单量，调用 `flight-service` 获取航班量，然后在内存中计算报表数据返回给前端。

### 总结建议
1.  **先拆分后新增**：先按照上面的目录结构，把现有的单体功能拆成微服务跑通（Gateway -> Auth -> Flight/Order）。
2.  **数据库先行**：执行 SQL 脚本更新 `users` 和 `airlines` 表。
3.  **中间件接入**：配置好 Nacos 和 Redis，确保服务能注册，缓存能写入。
4.  **最后做后台**：基础架构稳了之后，再写 Admin 相关的审核和统计逻辑。


测试：
```
INSERT INTO users (name, gender, id_card, phone, password, role, status, membership_level) 
VALUES ('张三', '男', '110101199001011234', '13800138000', '123456', 'ROLE_USER', 'ACTIVE', '普通');

INSERT INTO users (name, gender, id_card, phone, password, role, status, membership_level) 
VALUES ('管理员', '男', '110101198001010000', '13900139000', 'admin123', 'ROLE_PLATFORM_ADMIN', 'ACTIVE', '白金');
```


user的密码是否应该加密后存储于数据库，是否需要现在修改代码？


## 对应的工作进度：
这份总结将涵盖从单体架构向微服务架构迁移至今的所有关键节点。这是一个非常扎实的工程实践，我们已经完成了最艰难的基础设施搭建和核心服务拆分。

---

### 🟢 核心问题解答：密码加密

**问题**：User 的密码是否应该加密？是否现在修改？
**回答**：**必须加密，且必须现在修改。**

1.  **原因**：明文存储密码是严重的安防漏洞。Spring Security 默认机制也强烈建议使用加密。
2.  **方案**：使用 **BCryptPasswordEncoder**。
3.  **实施点**：
    *   **注册时 (`auth-service`)**：接收前端明文 -> `encoder.encode(password)` -> 存入数据库。
    *   **登录时 (`auth-service`)**：接收前端明文 -> `encoder.matches(raw, encoded)` -> 验证通过。
    *   **修改代码**：在开发 `auth-service` 时直接引入。不要等数据多了再改，那是巨大的历史包袱。

---

### 📋 项目重构工作全景梳理 (V0.1 -> Current)

#### 1. 架构与基础设施 (Infrastructure)

| 更改方向 | 涉及文件/模块 | 核心内容与改动 |
| :--- | :--- | :--- |
| **工程结构** | `pom.xml` (父工程) | 引入 Spring Cloud Alibaba BOM，管理所有子模块版本。 |
| **公共依赖** | `common-module` | **定位**：工具箱 (Jar)，非微服务。<br>**内容**：DTO, Enums, Utils (JWT), GlobalException, Feign接口。<br>**改动**：添加了 Security 和 JPA 依赖以支持工具类编译。 |
| **网关入口** | `gateway-service` | **定位**：流量大门。<br>**技术**：WebFlux (非 Servlet)。<br>**改动**：移除了旧的 `JwtAuthenticationFilter`，重写为 `AuthGlobalFilter`；配置了 Nacos 路由规则。 |
| **配置中心** | Nacos | **改动**：将 `application.yml` (DB, Redis, JWT) 迁移至 Nacos 配置列表；本地仅保留 `bootstrap.yml` 用于寻址。 |

#### 2. 数据库设计 (Database)

| 表名 | 变更内容 | 目的 |
| :--- | :--- | :--- |
| `users` | 重命名自 `customers`；新增 `role`, `airline_code`, `status`, `avatar_url`。 | 支持多角色（管理员/航司/用户）鉴权与审核。 |
| `tickets` | 外键 `customer_id` 改为 `user_id`。 | 保持命名一致性。 |
| `daily_flight_stock` | **新增表**。 | **关键优化**：实现库存与订单解耦，避免跨服务 Count 查询，提升性能。 |
| `airports` | **新增表**。 | 规范化城市与机场代码 (PEK, SHA)，支持前端下拉搜索。 |
| `messages` | **新增表**。 | 支持站内信通知（如审核通过通知）。 |

#### 3. 核心服务拆分 (Flight Service)

| 模块 | 更改内容 | 解决的问题 |
| :--- | :--- | :--- |
| **包结构** | `com.bighomework.planeTicketWeb` -> `com.bighomework.flight` | 规范化微服务包名，去除单体残留。 |
| **代码瘦身** | 删除了 Auth, Ticket 相关 Controller/Service/Repo。 | **高内聚**：Flight 服务只管航班和航司，不碰订单和用户。 |
| **策略模式** | 保留并优化 `PricingStrategy`。 | **解耦**：将库存因子改为通过参数传入，不再直接查 Ticket 表。 |
| **功能增强** | 集成 MinIO (`MinioUtils`, `FileController`)。 | 实现航司 Logo 上传。 |
| **性能优化** | 引入 Redis (`@Cacheable`)。 | 缓存航班搜索结果，减轻数据库压力。 |
| **远程调用** | 预埋 `OrderFeignClient`。 | 为未来调用订单服务查询销量做准备。 |

---

### 🔧 遇到的问题与解决方案 (Troubleshooting Log)

这是你在这个过程中积累的宝贵经验：

1.  **Maven 依赖与构建**
    *   **问题**：`gateway-service` 找不到 `spring-boot:run` 插件。
    *   **解决**：在子模块 `pom.xml` 中补全 `<build><plugins>...</plugins></build>`。
    *   **问题**：`gateway` 找不到 `common-module` 里的类。
    *   **解决**：理解 Maven 本地仓库机制，**必须在根目录执行 `mvn clean install`** 将 common 模块打包入库。

2.  **代码迁移与包名**
    *   **问题**：文件移动后，`package` 声明和 `import` 语句仍指向旧路径。
    *   **解决**：全局搜索替换，手动修正所有 DTO 和 Utils 的包路径。

3.  **Nacos 连接与配置**
    *   **问题**：`Connection refused: ...:9848` (gRPC 端口不通)。
    *   **解决**：确保 Nacos 2.x 端口开放，或检查网络环境。
    *   **问题**：`Client not connected` 导致无法拉取配置，进而报 `DataSource` 错误。
    *   **解决**：修复 Nacos 连接后，Spring Boot 成功拉取配置并启动。

4.  **数据库连接**
    *   **问题**：`Unknown database 'plane_ticket_db'`。
    *   **解决**：修改 Nacos 配置中的 JDBC URL，指向正确的 Schema (`planetickets`)。

5.  **技术栈冲突**
    *   **问题**：Gateway 引入了 `common-module` 导致被迫引入 JPA，且使用了 Servlet 过滤器。
    *   **解决**：Gateway 启动类排除 `DataSourceAutoConfiguration`；删除 Servlet 过滤器，重写 WebFlux 过滤器。

---

### 🚀 下一步工作规划 (Roadmap)

目前的进度：**基础架构 (100%)** -> **Flight服务 (90%)** -> **Gateway (100%)**。
接下来是核心业务逻辑的实现。

#### 阶段一：完善认证服务 (Auth-Service) —— *优先级最高*
*   **目标**：实现用户注册、登录、颁发 JWT。
*   **关键任务**：
    1.  **密码加密**：配置 `BCryptPasswordEncoder` Bean。
    2.  **注册接口**：接收 `RegisterRequest`，加密密码，存入 `users` 表。如果是航司管理员，设置状态为 `PENDING`。
    3.  **登录接口**：校验密码，生成 JWT (使用 `common-module` 的工具)，返回 Token。
    4.  **Nacos配置**：配置 Datasource, Redis, JWT Secret。

#### 阶段二：完善订单服务 (Order-Service)
*   **目标**：实现下单、扣减库存、查看订单。
*   **关键任务**：
    1.  **Feign 调用**：在下单时，调用 `FlightFeignClient` (需在 Flight 服务实现对应接口) 校验航班是否存在。
    2.  **库存扣减**：
        *   *简单版*：直接更新数据库。
        *   *进阶版*：调用 Flight 服务扣减 `daily_flight_stock` 表（涉及分布式事务，课程设计可用 Seata 或 简单的重试机制）。
    3.  **实现 `sold-count` 接口**：供 Flight 服务计算动态价格使用。

#### 阶段三：完善航班服务 (Flight-Service) 的剩余部分
*   **目标**：让动态定价真正跑通。
*   **关键任务**：
    1.  **对接 Feign**：在 `FlightServiceImpl` 中正式调用 `OrderFeignClient` 获取销量。
    2.  **库存初始化**：写一个定时任务或接口，每天自动生成 `daily_flight_stock` 数据。

#### 阶段四：后台管理服务 (Admin-Service)
*   **目标**：聚合数据，提供报表。
*   **关键任务**：
    1.  **审核功能**：查询 `status=PENDING` 的用户，调用 Auth 服务接口进行通过/拒绝。
    2.  **数据看板**：通过 Feign 并行调用 Flight 和 Order 服务，组装报表数据。

---

### 💡 给你的建议

你现在的状态非常好，环境已经跑通，最难的配置阶段已经过去。
**接下来的建议**：
1.  **先攻克 Auth-Service**：因为没有 Token，后续的下单、后台管理都无法测试。
2.  **写代码时保持“微服务思维”**：时刻提醒自己，“我不能直接查那张表，我要调接口”。
3.  **多用 `mvn install`**：只要改了 `common-module`，第一时间重新安装。
