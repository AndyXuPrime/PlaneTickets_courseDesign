## 1. 项目概要 (Project Overview)

**项目名称**：清风航空机票预订系统 (Qingfeng Aviation Ticket Reservation System)
**项目性质**：基于 Spring Cloud Alibaba 的分布式微服务课程设计
**项目背景**：
本项目旨在模拟真实的民航客运业务场景，解决传统单体架构在扩展性与维护性上的不足。系统经历了从 Spring Boot 单体架构向 **Spring Cloud Alibaba 微服务架构**的完整演进，实现了前后端分离。系统分为**C端用户前台**（购票/查询/个人中心）与**B端管理后台**（航班调度/票务核销/用户管理），支持多租户（不同航司）的数据隔离与管理。

---

## 2. 技术架构与实现 (Technical Implementation)

系统采用主流的 **前后端分离 + 微服务** 架构，确保了高可用性、高并发处理能力及良好的扩展性。

### 2.1 技术栈 (Tech Stack)

| 分层 | 技术组件 | 说明 |
| :--- | :--- | :--- |
| **前端架构** | **Vue 2.6** + **Element UI** | 核心框架与UI组件库 |
| | **Axios** | HTTP 客户端，统一封装拦截器（Token注入/错误处理） |
| | **Vue Router** | 路由管理，实现动态路由与权限守卫 |
| **后端架构** | **Spring Boot 3.2.x** | 基础微服务容器 |
| | **Spring Cloud Alibaba 2023** | 微服务全家桶 |
| | **Nacos** | **注册中心** (Service Discovery) & **配置中心** (Config) |
| | **Spring Cloud Gateway** | **服务网关**，基于 WebFlux 的统一入口与鉴权 |
| | **OpenFeign** | 声明式服务间调用 (RPC) |
| **数据持久化** | **MySQL 8.0** | 关系型数据库，存储核心业务数据 |
| | **Spring Data JPA** | ORM 框架，简化数据库操作 |
| **中间件** | **Redis** | 缓存中间件，用于航班搜索结果缓存 |
| | **MinIO** | 对象存储，用于存储航司 Logo、用户头像 |
| **安全与工具** | **Spring Security** + **JWT** | 无状态认证与授权 |
| | **BCrypt** + **AES** | 密码哈希加密与身份证对称加密 |

### 2.2 微服务模块划分 (Service Topology)

系统被拆分为 **1 个公共库 + 1 个网关 + 4 个业务微服务**：

1.  **`common-module` (公共依赖)**：
    *   存放全局 DTO、枚举 (`UserRole`, `TicketStatus`)、工具类 (`JwtTokenProvider`, `EncryptionUtils`)、Feign 接口定义。
2.  **`gateway-service` (网关服务 :8080)**：
    *   流量入口，负责路由分发 (`lb://service-name`)。
    *   **统一鉴权**：`AuthGlobalFilter` 解析 JWT，提取 UserID/Role 并透传至 Header。
3.  **`auth-service` (认证服务 :8081)**：
    *   用户注册、登录、JWT 颁发。
    *   **用户管理**：常用乘机人管理、用户资料修改、管理员审核。
4.  **`flight-service` (航班服务 :8082)**：
    *   航班计划管理、航司信息管理。
    *   **动态定价**：根据策略计算实时票价。
    *   **静态资源**：对接 MinIO 处理文件上传。
5.  **`order-service` (订单服务 :8083)**：
    *   核心交易链路：下单、支付（模拟）、退票、核销。
    *   **审计日志**：记录机票全生命周期状态变更。
6.  **`admin-service` (后台服务 :8084)**：
    *   数据聚合与报表统计。
    *   系统广播消息发布。

---

## 3. 核心设计亮点 (Core Design)

### 3.1 安全架构设计
*   **网关统一鉴权 + 服务端信任模型**：
    *   前端请求携带 Token 访问 Gateway。
    *   Gateway 校验签名，解析出 `X-User-Role` 和 `X-Airline-Code` 放入 Header。
    *   下游微服务（如 Flight Service）不再重复校验 Token，而是直接信任 Header 中的用户信息，实现无状态鉴权。
*   **全链路数据加密**：
    *   用户密码使用 `BCrypt` 强哈希存储。
    *   敏感信息（身份证号）在 Service 层使用 `AES` 加密后存入数据库，展示时脱敏。

### 3.2 动态定价策略 (Strategy Pattern)
*   摒弃固定票价，采用策略模式实现动态计算：
    *   **公式**：`最终价 = 基础价 × 舱位系数 × 时间因子 × 上座率因子`
    *   **实现**：`FlightService` 通过 Feign 调用 `OrderService` 获取实时销量，结合航班日期（淡旺季/临期）动态计算价格。

### 3.3 “一单多票”与库存解耦
*   **业务逻辑**：支持用户一次操作为多人购票。前端通过 `f_` 前缀区分“本人”与“常用乘机人”，后端 `OrderService` 自动解析并生成多张独立的 `Ticket` 记录。
*   **库存优化**：引入 `daily_flight_stock` 表，将库存查询从订单表 (`count(*)`) 中剥离，极大提升了高并发下的查询性能。

### 3.4 多租户权限隔离 (RBAC)
*   系统设计了三种角色：
    *   **ROLE_USER**：普通购票用户。
    *   **ROLE_PLATFORM_ADMIN**：平台总管，拥有所有权限（审核航司、管理所有航班）。
    *   **ROLE_AIRLINE_ADMIN**：航司管理员，**数据隔离**，仅能增删改查自己所属航司（`airline_code`）的航班和数据。

---

## 4. 功能详细设计 (Functional Specification)

### 4.1 用户前台 (Client Side)

| 模块 | 功能点 | 逻辑描述 |
| :--- | :--- | :--- |
| **航班查询** | 多维搜索 | 支持按“出发地-目的地”或“航空公司”搜索；搜索结果存入 **Redis** 缓存（TTL 10分钟）。 |
| **机票预订** | 乘机人选择 | 支持勾选本人及多位常用乘机人；前端自动计算总价；后端校验库存并落库。 |
| **我的行程** | 订单管理 | 展示逻辑订单（按预订时间分组）；支持对“已支付”状态的机票进行**退票**（需校验归属权）。 |
| **个人中心** | 常用乘机人 | 增删改查家属信息（身份证号加密存储）；修改个人头像（MinIO）和密码。 |
| **消息通知** | 站内信 | 接收管理员发布的系统广播消息。 |

### 4.2 管理后台 (Admin System)

后台采用 **侧边栏导航 + 顶部通栏** 布局，通过路由守卫强制校验管理员权限。

#### A. 数据概览 (Dashboard)
*   **数据聚合**：展示平台总用户数、今日订单量、总销售额、热门航线 TOP5。
*   **实现**：`admin-service` 直接连接数据库执行聚合查询，或通过 Feign 调用各业务服务。

#### B. 资源管理 (Resource)
*   **航司管理**：(仅平台管理员) 入驻新航司，修改航司基础信息及 Logo。
*   **航班调度**：
    *   **发布航班**：录入航班号、机型、起降时间、基础票价。
    *   **调价**：修改基础票价，触发 Redis 缓存清除 (`@CacheEvict`)。
    *   *权限控制*：航司管理员只能看到并操作自己航司的航班。

#### C. 票务中心 (Ticketing)
*   **订单查询**：多条件检索全平台订单。
*   **登机核销**：模拟机场柜台操作，将机票状态由 `已支付` 变更为 `已使用`。
*   **审计日志**：查看某张机票的完整操作记录（如：用户A下单 -> 用户A支付 -> 管理员B核销）。

#### D. 用户与权限 (CRM)
*   **用户管理**：查询用户信息，**手动调整会员等级**（普通/银/金/白金），**重置用户密码**。
*   **入驻审核**：处理状态为 `PENDING` 的航司管理员注册申请，审核通过后状态变为 `ACTIVE`。

#### E. 消息发布 (Broadcast)
*   **系统广播**：管理员发布全员可见的通知（如系统维护、优惠活动）。
*   **存储**：写入 `system_messages` 表，前端用户中心拉取展示。

---

## 5. 数据库设计摘要 (Database Schema)

*   **`users`**: 核心用户表，包含 `role`, `airline_code`, `status` 等鉴权字段。
*   **`flights`**: 航班基础信息表，包含 `base_price`。
*   **`tickets`**: 物理机票表，记录 `passenger_name`, `price`, `status`。
*   **`daily_flight_stock`**: 每日库存表，用于高性能扣减库存。
*   **`ticket_status_log`**: 状态变更审计表。
*   **`family_members`**: 常用乘机人表。
*   **`system_messages`**: 广播消息表。
*   **`airlines` / `airports`**: 基础字典表。

---

## 6. 总结
本项目通过微服务架构的实践，成功解决了一个复杂业务场景下的**高内聚、低耦合**需求。不仅实现了基础的业务闭环，还在**安全性（加密/鉴权）**、**性能（缓存/索引）**、**扩展性（多租户/接口隔离）** 等方面进行了深入设计，是一个具有较高工程质量的 Java EE 课程设计作品。