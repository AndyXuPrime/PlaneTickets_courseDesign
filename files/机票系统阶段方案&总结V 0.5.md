## 第一部分：系统架构设计与基础设施建设

### 1.1 技术栈选型与演进
本项目经历了从传统的 Spring Boot 单体架构向 **Spring Cloud Alibaba** 微服务架构的华丽转身。
*   **核心框架**：Spring Boot 3.x, Spring Cloud 2023.0.x, Spring Cloud Alibaba 2023.0.1.0。
*   **服务治理**：Nacos (作为注册中心与配置中心)。
*   **服务网关**：Spring Cloud Gateway (统一入口、鉴权透传、CORS处理)。
*   **通信机制**：OpenFeign (声明式服务调用)。
*   **持久化层**：MySQL 8.0 + Spring Data JPA。
*   **中间件**：Redis (搜索结果缓存)、MinIO (对象存储，处理头像与Logo)。
*   **前端**：Vue 2 + Element UI + Axios。

### 1.2 微服务职责划分
为了实现高内聚低耦合，系统被拆分为以下模块：
1.  **`common-module`**：公共依赖库，存放通用 DTO、枚举、工具类、Feign 接口。
2.  **`gateway-service`**：网关服务，负责路由分发、JWT 解析、Header 透传。
3.  **`auth-service`**：认证中心，管理用户、管理员、乘机人信息及权限审核。
4.  **`flight-service`**：航班中心，管理航司、航班、动态定价、文件上传。
5.  **`order-service`**：订单中心，处理下单、出票、退票、订单状态流转。
6.  **`admin-service`**：统计中心，负责全平台销售数据聚合。

---

## 第二部分：已完成功能验证与逻辑实现

### 2.1 多角色认证与权限隔离
**【实验验证】**：系统支持 `ROLE_USER`、`ROLE_AIRLINE_ADMIN`、`ROLE_PLATFORM_ADMIN` 三种角色。
*   **逻辑实现**：登录成功后，`auth-service` 将角色和航司代码（针对航司管理员）写入 JWT。网关解析 JWT 后，通过自定义 Header (`X-User-Role`, `X-Airline-Code`) 传递给下游。
*   **审核流**：航司管理员注册后处于 `PENDING` 状态，无法登录。必须由总管理员在后台点击“批准”后，状态转为 `ACTIVE` 方可进入系统。

### 2.2 航班搜索与动态定价系统
**【实验验证】**：用户可按航线或航司搜索航班。
*   **动态定价策略**：引入 `PricingStrategy` 模式。票价不再是死板的数字，而是由**基础价 × 舱位系数 × 时间因子 × 上座率因子**实时计算。
*   **缓存优化**：集成 Redis 缓存。首页推荐航班和搜索结果在 10 分钟内无需重复查询数据库，极大提升了响应速度。

### 2.3 “一单多票”预订逻辑（核心突破）
**【实验验证】**：支持用户一次性为自己和多名家人购买同一航班。
*   **乘机人解析**：前端通过 `f_` 前缀区分家人 ID。后端 `order-service` 远程调用 `auth-service` 获取家人姓名快照。
*   **数据结构**：`tickets` 表存储单张机票，通过 `booking_time` 逻辑聚合成一个订单。实现了“一份订单，多个姓名”的真实业务场景。

### 2.4 用户中心与文件云存储
**【实验验证】**：用户可在线修改邮箱、修改密码，并上传头像。
*   **MinIO 集成**：`flight-service` 充当文件服务器，将图片存储在 MinIO。通过 `mc` 命令行工具配置了 Bucket 的 `download` 权限，确保头像 URL 永久有效且可直接访问。

---

## 第三部分：困难、报错与改动全记录（技术精髓）

这是本项目开发过程中最具价值的部分，记录了多次从 500 报错到系统恢复的“战斗经历”。

### 3.1 跨域冲突与网关拦截 (CORS & Preflight)
*   **问题描述**：前端 8085 端口访问网关 8080 时，频繁报 `blocked by CORS policy`，即使网关配了跨域也无效。
*   **深度原因**：浏览器在发送正式请求前会发送 `OPTIONS` 预检请求。如果网关没有开启 `add-to-simple-url-handler-mapping: true`，且路由匹配不准确，预检请求会被拦截。
*   **改动方案**：在 Nacos 配置中开启关键开关，并使用 `allowedOriginPatterns: "*"` 替代 `allowedOrigins`。

### 3.2 Jackson 序列化死循环 (Infinite Recursion)
*   **问题描述**：访问航班列表时，后端报 `StackOverflowError` 或前端收不到响应。
*   **深度原因**：`Flight` 实体引用了 `Airline`，`Airline` 实体又反向引用了 `List<Flight>`。Jackson 在转 JSON 时陷入了 A->B->A 的死循环。
*   **改动方案**：在关联字段上添加 `@JsonIgnoreProperties` 或 `@JsonIgnore`，切断双向序列化链路。

### 3.3 数据库关键字与保留字冲突 (SQL Reserved Words)
*   **问题描述**：保存订单时报 `500 Internal Server Error`，日志显示 SQL 语法错误。
*   **深度原因**：`tickets` 表中有一个字段叫 `class`（舱位）。`class` 是 MySQL 的关键字，也是 Java 的保留字。
*   **改动方案**：在实体类映射中使用反引号包裹字段名：`@Column(name = "`class` ")`。

### 3.4 懒加载异常 (LazyInitializationException)
*   **问题描述**：管理员能看航班，用户看航班就报 500。
*   **深度原因**：管理员直接查实体，而用户需要将实体转 VO。转换过程中访问了懒加载的 `airline` 对象，此时 Session 已关闭。
*   **改动方案**：在 Service 层添加 `@Transactional(readOnly = true)`，并在 Repository 中使用 `JOIN FETCH` 显式立即加载关联对象。

### 3.5 身份证加密导致的长度溢出
*   **问题描述**：注册用户时崩溃。
*   **深度原因**：数据库 `id_card` 原本设为 `varchar(18)`。启用 AES 加密后，密文变成了 64 位以上的 Base64 字符串，导致数据库写入截断。
*   **改动方案**：将数据库和实体类中的 `idCard` 长度扩容至 `255`。

### 3.6 DTO 与 Feign 的同步问题
*   **问题描述**：`TypeError: api.xxx is not a function` 或后端 `Symbol not found`。
*   **深度原因**：在公共模块修改了 DTO 或 Feign 接口，但没有执行 `mvn install`，导致子服务引用的还是旧版 JAR 包。
*   **改动方案**：确立了“修改 Common -> 执行 `mvn clean install` -> 重启子服务”的标准开发流程。

---

## 第四部分：数据安全与健壮性设计

### 4.1 全链路加密
*   **密码安全**：全线弃用明文，使用 `BCryptPasswordEncoder`。数据库中只存哈希摘要，即使数据库泄露，黑客也无法还原原始密码。
*   **隐私安全**：对乘机人的身份证号进行 **AES 对称加密**。在 `tickets` 表和 `users` 表中，身份证号均以密文形式存在。

### 4.2 极致防崩逻辑 (Defensive Programming)
在 `FlightServiceImpl` 和 `TicketServiceImpl` 中，针对所有跨服务返回的对象和数据库字段进行了**非空保护**：
*   如果航司信息丢失，显示“未知航司”而非报错。
*   如果价格计算出错，返回“基础价”作为兜底。
*   如果旧订单没有 `passenger_name`，自动填充“历史乘客”。
*   这种设计确保了系统的**高可用性**，不会因为某一条脏数据导致整个页面崩溃。

---

## 第五部分：项目总结与展望

### 5.1 核心成就
1.  **架构标准化**：成功构建了一套基于 Spring Cloud Alibaba 的生产级微服务骨架。
2.  **业务闭环**：实现了从航司入驻审核、航班发布、动态定价、多乘机人下单到订单审计的完整业务流。
3.  **技术融合**：将 Redis 缓存、MinIO 对象存储、JWT 安全认证、Feign 远程调用等技术有机结合。

### 5.2 待改进方向
1.  **分布式事务**：目前下单与库存扣减尚未引入 Seata，仅靠逻辑校验。
2.  **消息驱动**：站内信功能目前是通过数据库轮询模拟，未来应接入 RabbitMQ 实现真正的异步通知。
3.  **前端工程化**：目前 Vue 2 代码略显臃肿，未来可考虑升级 Vue 3 + TypeScript。
