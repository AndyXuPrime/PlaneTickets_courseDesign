## 1. 总体技术架构 (Tech Stack)

*   **开发模式**：前后端分离 (Restful API)
*   **前端**：Vue 2 + Element UI + Axios + Vue Router + Vuex
*   **后端**：Spring Boot 3 + Spring Cloud Alibaba (Nacos, OpenFeign, Gateway)
*   **数据存储**：MySQL 8.0 (业务数据), Redis (缓存), MinIO (对象存储)
*   **构建工具**：Maven (后端), npm/Webpack (前端)

---

## 2. 后端项目架构 (Backend Architecture)
后端采用 **Maven 多模块聚合架构**。父工程管理依赖版本，子模块分为“公共库”和“独立微服务”。

### 2.1 后端文件目录结构

```text
backend/  [项目根目录]
├── pom.xml  (父工程配置文件，管理 Spring Cloud Alibaba 版本)
│
├── common-module/  [公共模块 - 工具箱]
│   ├── pom.xml
│   └── src/main/java/com/bighomework/common/
│       ├── dto/                  # 数据传输对象 (LoginResponse, BookingRequest...)
│       ├── enums/                # 通用枚举 (UserRole, TicketStatus, CabinClass...)
│       ├── exception/            # 全局异常定义 (BusinessException, GlobalExceptionHandler)
│       ├── feign/                # Feign 客户端接口 (AuthFeignClient, FlightFeignClient)
│       ├── security/             # JWT 工具类 (JwtTokenProvider)
│       └── util/                 # 通用工具 (ApiResponse, EncryptionUtils)
│
├── gateway-service/  [网关服务 - 统一入口 :8080]
│   ├── pom.xml
│   ├── src/main/resources/bootstrap.yml  (Nacos 寻址配置)
│   └── src/main/java/com/bighomework/
│       ├── GatewayApplication.java       (启动类，排除 DataSource)
│       ├── config/GatewaySecurityConfig.java (关闭 CSRF，放行请求)
│       └── filter/AuthGlobalFilter.java      (全局过滤器：校验 Token，传递 Header)
│
├── auth-service/  [认证服务 - 用户中心 :8081]
│   ├── pom.xml
│   ├── src/main/resources/bootstrap.yml
│   └── src/main/java/com/bighomework/auth/
│       ├── AuthApplication.java
│       ├── config/SecurityConfig.java    (BCrypt 加密配置)
│       ├── controller/AuthController.java (登录、注册、审核、内部查询)
│       ├── entity/User.java              (对应 users 表)
│       ├── repository/UserRepository.java
│       └── service/impl/AuthServiceImpl.java (注册逻辑：加密密码/身份证)
│
├── flight-service/  [航班服务 - 核心业务 :8082]
│   ├── pom.xml
│   ├── src/main/resources/bootstrap.yml
│   └── src/main/java/com/bighomework/flight/
│       ├── FlightApplication.java
│       ├── config/                       (FlightSecurityConfig, MinioConfig)
│       ├── controller/                   (FlightController, FileController)
│       ├── entity/                       (Flight, Airline)
│       ├── repository/                   (FlightRepository)
│       ├── service/impl/                 (FlightServiceImpl - 含 Redis 缓存)
│       ├── service/strategy/             (DynamicPricingStrategy - 动态定价)
│       └── utils/MinioUtils.java         (MinIO 上传工具)
│
├── order-service/  [订单服务 - 交易核心 :8083]
│   ├── pom.xml
│   ├── src/main/resources/bootstrap.yml
│   └── src/main/java/com/bighomework/order/
│       ├── OrderApplication.java
│       ├── config/OrderSecurityConfig.java
│       ├── controller/BookingController.java (下单、查单、退票)
│       ├── entity/                       (Ticket, TicketStatusLog)
│       ├── repository/TicketRepository.java
│       └── service/impl/TicketServiceImpl.java (核心：调用 Feign，计算价格，落库)
│
└── admin-service/  [后台管理 - 数据聚合 :8084]
    ├── pom.xml
    ├── src/main/resources/bootstrap.yml
    └── src/main/java/com/bighomework/admin/
        ├── AdminApplication.java
        ├── controller/DashboardController.java (报表接口)
        ├── repository/StatisticsRepository.java (只读查询统计)
        └── service/impl/AdminStatServiceImpl.java
```

### 2.2 后端架构详细说明

1.  **公共模块 (`common-module`)**：
    *   **角色**：它是所有微服务的依赖包（Jar），不独立运行。
    *   **核心功能**：存放所有微服务共用的代码。例如 `JwtTokenProvider` 在 Auth 服务用于生成 Token，在 Gateway 用于解析 Token；`UserRole` 枚举保证了所有服务对角色的定义一致。

2.  **网关服务 (`gateway-service`)**：
    *   **角色**：流量守门员。前端只与 8080 端口交互。
    *   **核心功能**：
        *   **路由转发**：根据路径 (`/api/auth`, `/api/flights`) 将请求分发给 Nacos 中注册的对应服务。
        *   **统一鉴权**：`AuthGlobalFilter` 拦截所有请求，校验 JWT 合法性，解析出 `UserId`, `Role`, `AirlineCode`，并放入 HTTP Header (`X-User-Name` 等) 传给下游。
        *   **跨域处理**：在 Nacos 配置中统一处理了 CORS，允许前端跨域访问。

3.  **认证服务 (`auth-service`)**：
    *   **角色**：用户与权限中心。
    *   **核心功能**：
        *   **安全存储**：使用 `BCrypt` 加密密码，使用 `AES` 加密身份证号。
        *   **Token 颁发**：登录成功后，生成包含用户角色和航司代码的 JWT。
        *   **内部接口**：提供 `/internal/user` 供 Order 服务远程查询用户信息。

4.  **航班服务 (`flight-service`)**：
    *   **角色**：商品中心。
    *   **核心功能**：
        *   **动态定价**：`PricingStrategy` 根据时间、舱位、库存（参数传入）计算实时票价。
        *   **性能优化**：查询接口集成了 Redis 缓存，减轻数据库压力。
        *   **资源管理**：集成 MinIO SDK，支持航司 Logo 上传。
        *   **数据隔离**：`/admin/list` 接口根据 Header 中的航司代码，只返回对应航司的数据。

5.  **订单服务 (`order-service`)**：
    *   **角色**：交易中心。
    *   **核心功能**：
        *   **服务编排**：下单时，先调 Auth 查人，再调 Flight 查票，最后自己生成订单。
        *   **逻辑解耦**：不直接关联 User 和 Flight 表，而是存储 ID 和快照数据。
        *   **状态管理**：管理机票的生命周期（预订 -> 支付 -> 取消/完成）。

6.  **后台服务 (`admin-service`)**：
    *   **角色**：数据分析中心。
    *   **核心功能**：采用**读写分离**策略，配置只读数据源，执行复杂的 SQL 聚合查询（如热门航线、销售报表），避免影响核心交易库的性能。

---

## 3. 前端项目架构 (Frontend Architecture)

前端是一个标准的 Vue CLI 项目，经过改造以适配后端微服务接口。

### 3.1 前端文件目录结构

```text
frontend/
├── package.json         (依赖管理，已修复 babel-runtime 冲突)
├── vue.config.js        (Webpack 配置，代理设置)
├── src/
│   ├── main.js          (入口文件，引入 ElementUI, FontAwesome)
│   ├── App.vue          (根组件，包含 Header 和 Footer)
│   ├── assets/          (静态资源，CSS)
│   │
│   ├── api/             [API 层 - 统一管理后端接口]
│   │   └── index.js     (配置 Axios 拦截器，定义 login, searchFlights, createBooking 等方法)
│   │
│   ├── store/           [状态管理 - Vue.observable]
│   │   └── index.js     (管理 user 信息、Token、以及全局模态框状态)
│   │
│   ├── router/          [路由层]
│   │   └── index.js     (定义路由规则，配置 beforeEach 路由守卫进行权限拦截)
│   │
│   ├── components/      [组件层 - 可复用 UI]
│   │   ├── AppHeader.vue         (导航栏，根据登录状态显示不同按钮)
│   │   ├── AppFooter.vue         (页脚)
│   │   ├── FlightSearchForm.vue  (首页航班搜索表单)
│   │   ├── AirlineSearchForm.vue (按航司搜索表单)
│   │   ├── FlightList.vue        (航班列表展示，含预订按钮)
│   │   ├── LoginModal.vue        (登录弹窗，独立 Axios 处理登录)
│   │   ├── RegisterModal.vue     (注册弹窗)
│   │   ├── OrderCard.vue         (订单卡片组件)
│   │   ├── FlightStatusDetail.vue(航班动态卡片)
│   │   └── FlightStatusSearchForm.vue
│   │
│   └── views/           [视图层 - 页面级组件]
│       ├── HomeView.vue          (首页，集成搜索和列表)
│       ├── BookingView.vue       (订单确认页，展示详情，提交订单)
│       ├── MyTicketsView.vue     (我的订单页，调用 Order 接口)
│       ├── ProfileView.vue       (会员中心)
│       ├── AdminView.vue         (后台管理页，包含仪表盘、航班管理、审核)
│       ├── FlightStatusView.vue  (航班动态查询页)
│       └── CustomerServiceView.vue
```

### 3.2 前端架构详细说明

1.  **API 统一管理 (`src/api/index.js`)**：
    *   **BaseURL**：统一指向 `http://localhost:8080` (Gateway)。
    *   **拦截器**：
        *   **Request**：自动从 `localStorage` 读取 Token 并放入 Header。
        *   **Response**：统一处理 401 (Token 过期自动登出)、403 (无权)、500 (服务器错误) 等状态码，弹出 Element UI 的 Message 提示。

2.  **状态管理 (`src/store/index.js`)**：
    *   使用轻量级的 `Vue.observable` 替代复杂的 Vuex。
    *   **持久化**：`setUser` 方法会将用户信息和 Token 同步写入 `localStorage`，保证刷新页面后登录状态不丢失。

3.  **路由权限控制 (`src/router/index.js`)**：
    *   **全局守卫 (`beforeEach`)**：
        *   检查 `meta.requiresAuth`：未登录拦截跳转首页。
        *   检查 `meta.requiresAdmin`：读取本地存储的用户 Role，如果是 `ROLE_USER` 试图访问 `/admin`，则拦截。

4.  **组件化设计**：
    *   **LoginModal**：是一个独立的弹窗组件，可以在任何页面被唤起。它内部使用了一个**全新独立的 Axios 实例**来发送登录请求，避免受到全局拦截器的循环影响。
    *   **AdminView**：根据 `user.role` 动态渲染 Tab 页。如果是平台管理员，显示“审核”Tab；如果是航司管理员，隐藏审核 Tab，且航班列表只显示自家数据。
